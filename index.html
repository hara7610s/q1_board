<!DOCTYPE html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>スコアボード</title>
<style>
  body {
    background: #0b0b0c;
    color: #e6eef6;
    font-family: system-ui, 'Noto Sans JP', sans-serif;
    margin: 16px;
  }

  h1 {
    font-size: 20px;
    margin: 0 0 12px;
  }

  h2 {
    font-size: 16px;
    margin: 16px 0 8px;
  }

  table {
    border-collapse: collapse;
    width: 100%
  }

  th,
  td {
    border-bottom: 1px solid rgba(230, 238, 246, 0.08);
    padding: 8px;
    text-align: left;
  }

  th {
    background: rgba(230, 238, 246, 0.03);
  }

  .muted {
    color: rgba(230, 238, 246, 0.6);
    font-size: 12px
  }

  /* スコアが10未満のときの色 */
  .lowScore {
    color: #ff3b3b;
  }

  /* 色は要検討 */

  /* 列幅を指定 */
  #tbl th:nth-child(1),
  #tbl td:nth-child(1) {
    width: 40px;
    text-align: center;
  }

  /* 馬番 */
  #tbl th:nth-child(2),
  #tbl td:nth-child(2) {
    width: 120px;
  }

  /* 馬名（可変） */
  #tbl th:nth-child(3),
  #tbl td:nth-child(3) {
    width: 60px;
    text-align: right;
  }

  /* オッズ */
  #tbl th:nth-child(4),
  #tbl td:nth-child(4) {
    width: auto;
  }

  /* 空の列 */
</style>

<body>
  <h1>恵比寿1R ウェディングアニバーサリーステークス</h1>
  <div class="muted">自動更新: 3秒ごと</div>

  <table id="tbl">
    <thead>
      <tr>
        <th>馬番</th>
        <th>馬名</th>
        <th>オッズ</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxjl7vT0D__xcchipc7__nfW5pltwSjmnI6Dt_MZgzk8wKh3U0i_7BEK8D9ONMT0Lty/exec?fn=ranking";

    // 各pickの重み（得点）
    const POINTS = { pick1: 1, pick2: 0.4, pick3: 0.2 };

    async function fetchRanking() {
      const res = await fetch(GAS_URL, { cache: 'no-store' });
      const json = await res.json();
      if (!json.ok) return;

      // スコア集計
      const scoreMap = {};
      Object.entries(POINTS).forEach(([key, weight]) => {
        Object.entries(json.popularity[key] || {}).forEach(([name, cnt]) => {
          scoreMap[name] = (scoreMap[name] || 0) + cnt * weight;
        });
      });

      // 逆正規化：合計 / 各スコア（score が 0 のときは Infinity として扱う）
      const entries = Object.entries(scoreMap); // [[name, score], ...]
      const total = entries.reduce((s, [, v]) => s + v, 0);

      const inv = entries
        .map(([name, score]) => ({ name, score, newScore: score ? total / score : Number.POSITIVE_INFINITY }))
        .sort((a, b) => a.newScore - b.newScore);

      // 表示
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      inv.forEach((r, i) => {
        const tr = document.createElement('tr');
        const tdRank = document.createElement('td');
        const tdName = document.createElement('td');
        const tdScore = document.createElement('td');
        const tdEmpty = document.createElement('td'); // 空セル
        // 馬名を全角/半角スペースで分割して、1個目を馬番、2個目を馬名として表示
        const parts = String(r.name || '').trim().split(/[\u3000\s]+/);
        tdRank.textContent = parts[0] || i;
        tdName.textContent = parts[1] || r.name || '';
        tdScore.textContent = (r.newScore === Number.POSITIVE_INFINITY) ? '∞' : r.newScore.toFixed(1);

        // スコアが数値で10未満ならオッズを赤文字で表示
        if (r.newScore !== Number.POSITIVE_INFINITY && r.newScore < 10) {
          tdScore.classList.add('lowScore');
        } else {
          tdScore.classList.remove('lowScore');
        }

        // 馬番ごとの背景色と文字色を個別指定（1〜8枠）
        const rankBgs = [
          '#FFFFFF', // 1_白
          '#222222', // 2_黒
          '#E60012', // 3_赤
          '#005BAC', // 4_青
          '#FFD700', // 5_黄
          '#00883E', // 6_緑
          '#F39800', // 7_橙
          '#F4B3C2'  // 8_桃
        ];
        const rankFgs = [
          '#000000', // 1_黒
          '#ffffff', // 2_白
          '#ffffff', // 3_白
          '#ffffff', // 4_白
          '#000000', // 5_黒
          '#ffffff', // 6_白
          '#ffffff', // 7_白
          '#000000'  // 8_黒
        ];
        // 馬番を数値として取得
        const umabanNum = parseInt(parts[0], 10);
        if (!isNaN(umabanNum) && umabanNum >= 1 && umabanNum <= rankBgs.length) {
          tdRank.style.background = rankBgs[umabanNum - 1];
          tdRank.style.color = rankFgs[umabanNum - 1];
        } else {
          tdRank.style.background = '';
          tdRank.style.color = '';
        }

        tr.append(tdRank, tdName, tdScore, tdEmpty);
        tbody.appendChild(tr);
      });
    }

    fetchRanking();
    setInterval(fetchRanking, 3000);
  </script>
</body>

</html>